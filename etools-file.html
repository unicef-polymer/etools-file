<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<link rel="import" href="../paper-input/paper-input-container.html">

<!--
`etools-file`

This element will allow you to select and prepare the files you are gonna upload.
The component doesn't upload the files, it just manages an array of them, which is reachable from the parent component.

### Styling

You can use defined variables to change element style.

Custom property | Description | Default
----------------|-------------|----------
`--etools-file-secondary-text-color` | Secondary text color | `rgba(255, 255, 255, 0.54)`
`--etools-file-main-btn-color` | Main buttons text color(upload and download buttons) | `#00acff`
`--etools-file-delete-btn-color` | Delete button text color | `#f1572a`
`--etools-file-single-file-wrapper` | Mixin applied to single file name wrapper | `{}`

@demo demo/index.html
-->

<dom-module id="etools-file">

  <template>
    <style>
      :host {
        display: block;
        width: 100%;

      --paper-input-container-underline:	{
          display: none;
        };
        --paper-input-container-underline-focus:	{
          display: none;
        };
        --paper-input-container-underline-disabled: {
          display: none;
        };
      }

      [hidden] {
        display: none !important;
      }

      .files-container.multiple,
      .file-area,
      .upload-button-wrapper {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }
      .file-area {
        position: relative;
      }
      .selected-file-container,
      .file-actions {
        display: inline-block;
      }

      .file-actions paper-button,
      .selected-file-container iron-icon,
      .file-name-wrapper,
      .selected-file-container,
      .file-actions {
        float: left;
      }
      .selected-file-container {
        max-width: calc(100% - 208px);
      }
      .file-actions {
        @apply(--layout-horizontal);
        width: 208px;
      }
      .files-container.multiple .file-actions {
        @apply(--layout-flex);
        @apply(--layout-end-justified);
      }
      .files-container:not(.multiple) .file-name-wrapper {
        @apply(--etools-file-single-file-wrapper);
      }
      .selected-file-container.only-selected {
        max-width: calc(100% - 155px);
      }
      .file-actions.only-selected {
        width: 155px;
      }
      :host([readonly]) .selected-file-container {
        max-width: calc(100% - 135px);
      }
      :host([readonly]) .file-actions {
        width: 135px;
      }

      .file-name-wrapper {
        display: inline-block;
        width: calc(100% - 32px);
        line-height: 24px;
        height: 24px;
      }

      .file-name {
        display: inline-block;
        width: 100%;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        font-size: 16px;
      }

      paper-button iron-icon,
      .file-icon {
        margin-right: 8px;
      }

      .upload-button {
        --paper-button: {
          @apply(--layout-flex);
          @apply(--layout-start-justified);
          font-weight: bold;
          font-size: 14px;
          margin: 0;
          padding: 0 5px 0 0;
        };
        --paper-button-ink-color: rgba(255, 255, 255, 0);
      }

      .change-button,
      .delete-button,
      .download-button {
        --paper-button: {
          @apply(--layout-center-justified);
          font-weight: bold;
          font-size: 14px;
          padding: 0 5px;
          margin: 0 0 0 15px;
          min-width: 0;
          width: auto;
        };
      }

      .change-button,
      .file-icon {
        color: var(--etools-file-secondary-text-color, rgba(0, 0, 0, 0.54));
      }

      :host(:not([readonly])) .upload-button,
      .download-button {
        color: var(--etools-file-main-btn-color, #00acff);
      }
      .delete-button {
        color: var(--etools-file-delete-btn-color, #f1572a);
      }

      .files-container.multiple .files-wrapper {
        @apply(--layout-flex);
      }

      .files-container.multiple .upload-button-wrapper {
        @apply(--layout-vertical);
        @apply(--layout-end-justified);
      }
      .files-container .upload-button-wrapper > span {
        @apply(--layout);
      }

      .files-container.multiple {
        @apply(--layout-vertical);
      }

      .files-container.multiple .files-wrapper:not([hidden]) + .upload-button-wrapper .upload-button {
        margin-top: 15px;
      }

      .files-container.multiple .file-area + .file-area {
        margin-top: 6px;
      }

      :host([readonly]) .files-container.multiple .upload-button-wrapper {
        display: none;
      }

    </style>

    <paper-input-container always-float-label disabled$="[[disabled]]">

      <label hidden$="[[!_showLabel(label)]]" aria-hidden="true">[[label]]</label>

      <div class$="files-container [[_getMultipleClass(multiple)]]">
        <div class="files-wrapper" hidden$="[[!showFilesContainer]]">
          <template is="dom-repeat" items="[[files]]" as="file">

            <div class="file-area">

              <div class$="selected-file-container [[_getFileSelectedClass(file)]]">
                <iron-icon class="file-icon" icon="attachment"></iron-icon>
                <div class="file-name-wrapper">
                  <span class="file-name" title="[[file.file_name]]">[[file.file_name]]</span>
                </div>
              </div>
              <div class$="file-actions [[_getFileSelectedClass(file)]]">
                <!-- download btn if file was uploaded -->
                <paper-button class="download-button"
                              disabled$="[[!_showDownloadBtn(file)]]"
                              hidden$="[[!_showDownloadBtn(file)]]"
                              on-tap="_downloadFile"
                              title="Download">
                  <iron-icon icon="cloud-download"></iron-icon>
                  Download
                </paper-button>

                <paper-button class="change-button"
                              on-tap="_changeFile"
                              disabled$="[[_showDownloadBtn(file)]]"
                              hidden$="[[_showDownloadBtn(file)]]">
                  Change
                </paper-button>

                <paper-button class="delete-button"
                              on-tap="_deleteFile"
                              disabled$="[[readonly]]"
                              hidden$="[[readonly]]">
                  Delete
                </paper-button>
              </div>
            </div>
          </template>
        </div>

        <div class="upload-button-wrapper" hidden$="[[!_showUploadBtn(files.length)]]">
          <span>
            <paper-button class="upload-button"
                          on-tap="_openFileChooser"
                          title="[[uploadLabel]]"
                          disabled$="[[readonly]]">
            <iron-icon icon="file-upload"></iron-icon>
            [[uploadLabel]]
            </paper-button>
          </span>
        </div>
      </div>
      <input
          hidden
          class="paper-input-input"
          type="file"
          id="fileInput"
          on-change="_fileSelected"
          multiple="[[multiple]]"
          accept="{{accept}}">

      <a id="downloader" hidden></a>

    </paper-input-container>

    <paper-toast id="fileAlreadySelectedToast" always-on-top></paper-toast>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'etools-file',

        properties: {
          label: {
            type: String,
            value: "File attachment"
          },
          files: {
            type: Object,
            value: function() {
              return [];
            },
            notify: true
          },
          multiple: {
            type: Boolean,
            value: false
          },
          disabled: {
            type: Boolean,
            value: false
          },
          accept: {
            type: String
          },
          uploadLabel: {
            type: String,
            value: 'Upload File'
          },
          readonly: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          }
        },

        observers: [
          '_filesChange(files.*)'
        ],

        ready: function() {
          if (this.multiple && this.label === 'File attachment') {
            this.set('label', this.label + '(s)');
          }
          if (!Array.isArray(this.files)) {
            this.files = [];
          }
        },

        _showLabel: function(label) {
          return typeof label === 'string' && label !== '';
        },

        _showUploadBtn: function(filesLength) {
          if (!this.multiple && filesLength > 0) {
            return false;
          }
          return true;
        },

        _showDownloadBtn: function(file) {
          if (file && file.path !== '') {
            return true;
          }
          return false;
        },

        _getFileSelectedClass: function(file) {
          if (!this._showDownloadBtn(file)) {
            return 'only-selected'
          }
          return '';
        },

        _openFileChooser: function() {
          var elem = this.$.fileInput;
          if (elem && document.createEvent) {
            var evt = document.createEvent('MouseEvents');
            evt.initEvent('click', true, false);
            elem.dispatchEvent(evt);
          }
        },

        _replaceFile: function(newFile) {
          if (this.changeFileIndex >= 0) {
            this.$.fileInput.setAttribute('multiple', this.multiple);
            this.set('disabled', false);
            if (this.files[this.changeFileIndex]) {
              this.set('files.' + this.changeFileIndex, {
                id: '',
                file_name: newFile.name,
                path: '',
                raw: newFile
              });
            }
            this.changeFileIndex = -1;
            return true
          }
          return false;
        },

        _addMultipleFiles: function(files) {
          var filesAlreadySelected = [];
          for (var i = 0; i < files.length; i++) {
            var fileAlreadySelected = this.files.filter(function(f) {
              return f.file_name === files[i].name && f.path === '';
            });
            if (fileAlreadySelected.length === 0) {
              this.push('files', {
                id: '',
                file_name: files[i].name,
                path: '',
                raw: files[i]
              });
            } else {
              filesAlreadySelected.push(fileAlreadySelected[0]);
            }
          }
          if (filesAlreadySelected.length > 0) {
            // show a warning with the already selected files
            var toastWarningMessage = '<p><strong>The following file are already selected:</strong><p>';
            filesAlreadySelected.forEach(function(alreadySelectedFile) {
              toastWarningMessage += '<p>' + alreadySelectedFile.file_name + '</p>';
            });
            Polymer.dom(this.$.fileAlreadySelectedToast).innerHTML = toastWarningMessage;
            this.$.fileAlreadySelectedToast.open();
            filesAlreadySelected = [];
          }
        },

        _addSingleFile: function(file) {
          if (file) {
            var fileObj = {
              id: '',
              file_name: file.name,
              path: '',
              raw: file
            };
            if (this.files.length === 0) {
              // add file
              this.push('files', fileObj);
            } else {
              // replace/change file
              this.set('files.0', fileObj);
            }
          }
        },

        _fileSelected: function(e) {
          var files = e.target.files;
          // replace file if case
          if (this._replaceFile(files[0]) === true) {
            return;
          }

          // new files selected
          if (this.multiple) {
            this._addMultipleFiles(files);
          } else {
            // single file upload
            var file = e.target.files[0];
            this._addSingleFile(file);
          }
          // reset file input
          this.$.fileInput.value = null;
        },

        _changeFile: function(e) {
          if (e.model.index >= 0) {
            this.changeFileIndex = e.model.index;
            this.set('disabled', true);
            this.$.fileInput.removeAttribute('multiple');
            this._openFileChooser();
          }
        },

        _deleteFile: function(e) {
          if (!this.multiple) {
            if (this.files.length > 0) {
              this.set('files', []);
            }
          } else {
            if (typeof e.model.index === 'number' && e.model.index >= 0) {
                this.splice('files', e.model.index, 1);
            }
          }
        },

        _filesChange: function() {
          if (this.files instanceof Array && this.files.length > 0) {
            this.set('showFilesContainer', true);
          } else {
            this.set('showFilesContainer', false);
          }

          if (!this.multiple) {
            if (this.files instanceof Array && this.files.length > 1) {
              this.set('files', [this.files[0]]);
            }
          }
        },

        _downloadFile: function(e) {
          if (this.files.length > 0) {
            var file = this.files[0];
            if (this.multiple && this.files[e.model.index]) {
              file = this.files[e.model.index];
            }
            if (typeof file !== 'undefined' && file.path !== '') {
              var a = this.$.downloader;
              a.href = file.path;
              a.download = file.file_name;
              a.click();
              window.URL.revokeObjectURL(file.path);
            }
          }
        },

        _getMultipleClass: function(multiple) {
          if (multiple) {
            return 'multiple';
          }
          return '';
        },


      });
    })();
  </script>
</dom-module>
